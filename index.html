<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Usados | Tienda Oficial</title>
    <style>
        :root {
            --primario: #1a1a1a;
            --acento: #007bff;
            --fondo: #f4f7f6;
            --blanco: #ffffff;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--fondo); color: #333; scroll-behavior: smooth; }

        header { 
            background: var(--primario); 
            color: white; 
            padding: 40px 20px; 
            text-align: center;
            border-bottom: 5px solid var(--acento);
        }

        .vitrina-container {
            max-width: 1200px;
            margin: 40px auto;
            position: relative;
            padding: 0 60px;
        }

        .visor { overflow: hidden; border-radius: 15px; min-height: 450px; }

        .grid-productos { 
            display: flex; 
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            gap: 20px;
            padding: 20px 0;
        }

        /* TARJETA */
        .tarjeta {
            min-width: 280px;
            background: var(--blanco);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: 0.3s;
        }

        /* CONTENEDOR DE IMAGEN Y PUNTOS */
        .img-contenedor {
            position: relative;
            width: 100%;
            height: 220px;
            background: #eee;
            overflow: hidden;
        }

        .tarjeta img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: opacity 0.3s;
        }

        .galeria-nav {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            background: rgba(0,0,0,0.4);
            padding: 6px 12px;
            border-radius: 20px;
            z-index: 5;
        }

        .punto {
            width: 8px;
            height: 8px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            cursor: pointer;
            transition: 0.3s;
        }

        .punto.activo { background: var(--blanco); transform: scale(1.3); }

        .contenido { padding: 20px; text-align: center; flex-grow: 1; }
        
        .precio { font-size: 1.4rem; font-weight: bold; color: var(--acento); display: block; margin: 10px 0; }

        .badge { font-size: 0.75rem; padding: 5px 12px; border-radius: 50px; font-weight: bold; display: inline-block; margin-bottom: 10px; }
        .alto { background: #d4edda; color: #155724; }
        .agotado { background: #f8d7da; color: #721c24; }

        /* NAVEGACIÓN CARRUSEL */
        .btn-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: var(--blanco); border: 2px solid var(--primario);
            width: 45px; height: 45px; border-radius: 50%; cursor: pointer;
            font-size: 1.2rem; z-index: 10; font-weight: bold;
        }
        .btn-prev { left: 5px; } .btn-next { right: 5px; }

        /* CONTACTO */
        .seccion-contacto { background: var(--blanco); padding: 60px 20px; text-align: center; }
        .form-caja { max-width: 500px; margin: auto; }
        form { display: flex; flex-direction: column; gap: 15px; }
        input, textarea { padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .btn-enviar { background: var(--primario); color: white; padding: 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; }

        #mensaje-estado { text-align: center; padding: 50px; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <h1>Mis Usados</h1>
        <p>Catálogo Digital con Galería</p>
    </header>

    <div class="vitrina-container">
        <button class="btn-nav btn-prev" onclick="mover(-1)">❮</button>
        <button class="btn-nav btn-next" onclick="mover(1)">❯</button>
        
        <div class="visor">
            <div id="mensaje-estado">Cargando catálogo...</div>
            <div class="grid-productos" id="catalogo"></div>
        </div>
    </div>

    <section class="seccion-contacto" id="pedido-seccion">
        <div class="form-caja">
            <h2>Realizar Pedido</h2>
            <form action="https://formspree.io/f/rrvarela@outlook.com" method="POST">
                <input type="text" name="nombre" placeholder="Tu nombre" required>
                <textarea id="txt-mensaje" name="mensaje" rows="4" placeholder="Selecciona un producto del catálogo..." required></textarea>
                <button type="submit" class="btn-enviar">Enviar a WhatsApp / Mail</button>
            </form>
        </div>
    </section>

    <script>
        const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3fcYWk6ira5SgkWGjS5-tVBvFAMPGUS9ggADgr-Wg8OzWRZGU47SehGfNIFc3EA/pub?output=csv";
        
        let productos = [];
        let scrollPos = 0;

        function corregirImagen(url) {
            if (!url || url.trim() === "" || url.includes("undefined")) return null;
            if (url.includes("picsum.photos")) return url;
            let id = "";
            if (url.includes("id=")) {
                id = url.split("id=")[1].split("&")[0];
            } else if (url.includes("/d/")) {
                id = url.split("/d/")[1].split("/")[0];
            }
            return id ? `https://drive.google.com/uc?export=view&id=${id}` : url;
        }

        async function cargarDatos() {
            try {
                const res = await fetch(URL_CSV + "&t=" + new Date().getTime());
                const csv = await res.text();
                const filas = csv.split(/\r?\n/).slice(1);
                
                productos = filas.map(f => {
                    const c = f.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    const imgs = [corregirImagen(c[2]), corregirImagen(c[3]), corregirImagen(c[4])].filter(i => i !== null);
                    return {
                        nombre: c[0]?.replace(/"/g, '').trim(),
                        precio: c[1]?.replace(/"/g, '').trim(),
                        imagenes: imgs,
                        stock: parseInt(c[5]) || 0
                    };
                }).filter(p => p.nombre);

                document.getElementById('mensaje-estado').style.display = "none";
                renderizar();
            } catch (e) {
                document.getElementById('mensaje-estado').innerHTML = "Error al cargar el catálogo.";
            }
        }

        function renderizar() {
            const contenedor = document.getElementById('catalogo');
            contenedor.innerHTML = "";
            productos.forEach((p, i) => {
                let puntosHTML = "";
                if (p.imagenes.length > 1) {
                    puntosHTML = `<div class="galeria-nav">` + 
                        p.imagenes.map((_, idx) => `<span class="punto ${idx===0?'activo':''}" onclick="cambiarFoto(${i}, ${idx}, this)"></span>`).join('') + 
                    `</div>`;
                }

                const card = document.createElement('div');
                card.className = 'tarjeta';
                card.style.opacity = p.stock <= 0 ? "0.6" : "1";

                card.innerHTML = `
                    <div class="img-contenedor">
                        <img src="${p.imagenes[0]}" id="foto-${i}" onerror="this.src='https://via.placeholder.com/300?text=Error+de+Imagen'">
                        ${puntosHTML}
                    </div>
                    <div class="contenido">
                        <span class="badge ${p.stock > 0 ? 'alto' : 'agotado'}">
                            ${p.stock > 0 ? 'Disponible: ' + p.stock : 'Agotado'}
                        </span>
                        <h3>${p.nombre}</h3>
                        <span class="precio">${p.precio}</span>
                        <button class="btn-enviar" style="padding:10px; font-size:0.9rem;" 
                                onclick="seleccionar('${p.nombre}')" ${p.stock <= 0 ? 'disabled' : ''}>
                            Seleccionar
                        </button>
                    </div>
                `;
                contenedor.appendChild(card);
            });
        }

        function cambiarFoto(pIdx, imgIdx, el) {
            document.getElementById(`foto-${pIdx}`).src = productos[pIdx].imagenes[imgIdx];
            const pnts = el.parentElement.querySelectorAll('.punto');
            pnts.forEach(p => p.classList.remove('activo'));
            el.classList.add('activo');
        }

        function mover(dir) {
            const ancho = 300;
            const limite = (productos.length - 1) * ancho;
            scrollPos += (dir * -ancho);
            if (scrollPos < -limite) scrollPos = -limite;
            if (scrollPos > 0) scrollPos = 0;
            document.getElementById('catalogo').style.transform = `translateX(${scrollPos}px)`;
        }

        function seleccionar(nom) {
            document.getElementById('txt-mensaje').value = "Hola Mis Usados, me interesa el producto: " + nom;
            document.getElementById('pedido-seccion').scrollIntoView();
        }

        window.onload = cargarDatos;
    </script>
</body>
</html>
