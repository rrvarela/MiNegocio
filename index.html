<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Usados | Tienda Oficial</title>
    <style>
        :root {
            --primario: #1a1a1a;
            --acento: #007bff;
            --fondo: #f4f7f6;
            --blanco: #ffffff;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--fondo); color: #333; scroll-behavior: smooth; }

        header { 
            background: var(--primario); color: white; padding: 40px 20px; text-align: center;
            border-bottom: 5px solid var(--acento);
        }

        .vitrina-container {
            max-width: 1200px; margin: 40px auto; position: relative; padding: 0 60px;
        }

        .visor { overflow: hidden; border-radius: 15px; min-height: 480px; }

        .grid-productos { 
            display: flex; transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            gap: 20px; padding: 20px 0;
        }

        .tarjeta {
            min-width: 280px; background: var(--blanco); border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden;
            display: flex; flex-direction: column; transition: 0.3s;
        }

        .img-contenedor {
            position: relative; width: 100%; height: 250px; background: #eee;
        }

        .tarjeta img { width: 100%; height: 100%; object-fit: cover; }

        .galeria-nav {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 6px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 20px;
        }

        .punto { width: 8px; height: 8px; background: rgba(255,255,255,0.4); border-radius: 50%; cursor: pointer; }
        .punto.activo { background: white; transform: scale(1.2); }

        .contenido { padding: 20px; text-align: center; flex-grow: 1; }
        .precio { font-size: 1.4rem; font-weight: bold; color: var(--acento); display: block; margin: 10px 0; }
        .badge { font-size: 0.75rem; padding: 5px 12px; border-radius: 50px; font-weight: bold; display: inline-block; margin-bottom: 10px; }
        .disponible { background: #d4edda; color: #155724; }
        .agotado { background: #f8d7da; color: #721c24; opacity: 0.8; }

        .btn-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: white; border: 2px solid var(--primario);
            width: 45px; height: 45px; border-radius: 50%; cursor: pointer;
            font-size: 1.2rem; z-index: 10;
        }
        .btn-prev { left: 5px; } .btn-next { right: 5px; }

        .seccion-contacto { background: white; padding: 50px 20px; }
        .btn-seleccionar { 
            background: var(--acento); color: white; border: none; padding: 10px; 
            border-radius: 5px; width: 100%; cursor: pointer; font-weight: bold; 
        }
        .btn-seleccionar:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <header>
        <h1>Mis Usados</h1>
        <p>Catálogo Digital con Galería</p>
    </header>

    <div class="vitrina-container">
        <button class="btn-nav btn-prev" onclick="mover(-1)">❮</button>
        <button class="btn-nav btn-next" onclick="mover(1)">❯</button>
        <div class="visor">
            <div id="mensaje-estado" style="text-align: center; padding: 50px;">Cargando productos...</div>
            <div class="grid-productos" id="catalogo"></div>
        </div>
    </div>

    <section class="seccion-contacto" id="pedido-seccion">
        <div style="max-width: 500px; margin: auto;">
            <h2 style="text-align: center;">Tu Pedido</h2>
            <form action="https://formspree.io/f/rrvarela@outlook.com" method="POST" style="display: flex; flex-direction: column; gap: 15px;">
                <input type="text" name="nombre" placeholder="Tu nombre" required>
                <textarea id="txt-mensaje" name="mensaje" rows="4" placeholder="Selecciona un producto..." required></textarea>
                <button type="submit" style="background: var(--primario); color: white; padding: 15px; border: none; border-radius: 8px; cursor: pointer;">Enviar Consulta</button>
            </form>
        </div>
    </section>

    <script>
        const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3fcYWk6ira5SgkWGjS5-tVBvFAMPGUS9ggADgr-Wg8OzWRZGU47SehGfNIFc3EA/pub?output=csv";
        let productos = [];
        let scrollPos = 0;

        // FUNCIÓN MEJORADA: Limpia cualquier enlace de Google Drive para hacerlo imagen directa
        function corregirImagen(url) {
            if (!url || url.trim().length < 10) return null;
            let id = "";
            const cleanUrl = url.trim();
            
            if (cleanUrl.includes("id=")) {
                id = cleanUrl.split("id=")[1].split("&")[0];
            } else if (cleanUrl.includes("/d/")) {
                id = cleanUrl.split("/d/")[1].split("/")[0];
            } else if (cleanUrl.includes("open?")) {
                id = cleanUrl.split("id=")[1].split("&")[0];
            }

            // Usamos el servidor de contenido de Google que es el más estable para imágenes
            return id ? `https://lh3.googleusercontent.com/u/0/d/${id}` : cleanUrl;
        }

        async function cargarDatos() {
            try {
                const res = await fetch(URL_CSV + "&t=" + new Date().getTime());
                const csv = await res.text();
                const filas = csv.split(/\r?\n/).filter(line => line.trim() !== "");
                
                productos = filas.slice(1).map(f => {
                    const c = f.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    
                    // Aseguramos que limpiamos comillas y espacios de los enlaces
                    const cleanLink = (str) => str ? str.replace(/"/g, '').trim() : null;

                    const imgs = [
                        corregirImagen(cleanLink(c[2])), 
                        corregirImagen(cleanLink(c[3])), 
                        corregirImagen(cleanLink(c[4]))
                    ].filter(i => i !== null);

                    const stockValue = cleanLink(c[5]);
                    const stockNum = parseInt(stockValue);

                    return {
                        nombre: cleanLink(c[0]),
                        precio: cleanLink(c[1]),
                        imagenes: imgs.length > 0 ? imgs : ["https://via.placeholder.com/400x300?text=Imagen+No+Disponible"],
                        stock: isNaN(stockNum) ? 0 : stockNum
                    };
                }).filter(p => p.nombre);

                document.getElementById('mensaje-estado').style.display = "none";
                renderizar();
            } catch (e) {
                document.getElementById('mensaje-estado').innerHTML = "Error al conectar con el catálogo.";
            }
        }

        function renderizar() {
            const contenedor = document.getElementById('catalogo');
            contenedor.innerHTML = "";
            productos.forEach((p, i) => {
                const card = document.createElement('div');
                card.className = 'tarjeta';
                
                let puntosHTML = "";
                if (p.imagenes.length > 1) {
                    puntosHTML = `<div class="galeria-nav">` + 
                        p.imagenes.map((_, idx) => `<span class="punto ${idx===0?'activo':''}" onclick="cambiarFoto(${i}, ${idx}, this)"></span>`).join('') + 
                    `</div>`;
                }

                card.innerHTML = `
                    <div class="img-contenedor">
                        <img src="${p.imagenes[0]}" id="foto-${i}" onerror="falloImagen(this)">
                        ${puntosHTML}
                    </div>
                    <div class="contenido">
                        <span class="badge ${p.stock > 0 ? 'disponible' : 'agotado'}">
                            ${p.stock > 0 ? 'Stock: ' + p.stock : 'Agotado'}
                        </span>
                        <h3>${p.nombre}</h3>
                        <span class="precio">$${p.precio}</span>
                        <button class="btn-seleccionar" onclick="seleccionar('${p.nombre}')" ${p.stock <= 0 ? 'disabled' : ''}>
                            ${p.stock > 0 ? 'Seleccionar' : 'Sin Stock'}
                        </button>
                    </div>
                `;
                contenedor.appendChild(card);
            });
        }

        // Función de respaldo si la imagen directa falla
        function falloImagen(img) {
            if (img.src.includes("lh3.googleusercontent")) {
                // Si el primer método falla, intentamos el segundo método de Google Drive
                const id = img.src.split("/d/")[1];
                img.src = `https://drive.google.com/uc?export=view&id=${id}`;
            } else {
                img.src = 'https://via.placeholder.com/400x300?text=Error+de+Carga';
            }
        }

        function cambiarFoto(pIdx, imgIdx, el) {
            document.getElementById(`foto-${pIdx}`).src = productos[pIdx].imagenes[imgIdx];
            el.parentElement.querySelectorAll('.punto').forEach(p => p.classList.remove('activo'));
            el.classList.add('activo');
        }

        function mover(dir) {
            const ancho = 300;
            const limite = (productos.length - 1) * ancho;
            scrollPos += (dir * -ancho);
            if (scrollPos < -limite) scrollPos = -limite;
            if (scrollPos > 0) scrollPos = 0;
            document.getElementById('catalogo').style.transform = `translateX(${scrollPos}px)`;
        }

        function seleccionar(nom) {
            document.getElementById('txt-mensaje').value = "Hola Mis Usados, me interesa: " + nom;
            document.getElementById('pedido-seccion').scrollIntoView();
        }

        window.onload = cargarDatos;
    </script>
</body>
</html>
